# This is a basic workflow that is manually triggered

name: Create Release

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  verify:

    runs-on: ubuntu-latest
    
    outputs:
      release_verified: ${{ steps.semantic.outputs.new_release_published }}
      release_version: ${{ steps.semantic.outputs.new_release_version }}
      release_notes: ${{ steps.semantic.outputs.new_release_notes }}

    steps:

      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Install
        run: npm i

      - name: Bump Version
        run: npx semantic-release
      
      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v2
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
      
    runs-on: ubuntu-latest
    
    needs: verify
    
    if: needs.verify.outputs.release_verified
    
    steps:

      - name: Build
        run: npm run build

      - name: Create Release Asset # This would actually build your project, using zip for an example artifact
        run: |
          zip -r theme.zip dist/angular-project

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          release_name: Theme v${{ needs.verify.outputs.release_version }}
          body: ${{ needs.verify.outputs.release_notes }}
          draft: true
          prerelease: false

      # Upload artifact to the release
      - name: Upload Release Asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          asset_path: ./theme.zip
          asset_name: theme.zip
          asset_content_type: application/zip
